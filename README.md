# SeaTable App Development

The SeaTable app allows you to provide additional functionality to a table according to your needs. The SeaTable app is written in JavaScript language. After compiling and packaging, it can be installed into a table.

This repository provides templates and packaging scripts for apps.

## App Development Library

Plug-in development can use the following two libraries

1. dtable-sdk, which provides an API for reading and writing the current dtable data (https://docs.seatable.io/published/dtable-sdk/home.md)
2. (Optional) dtable-ui-component, which provides a reusable UI component library (to be improved)

> A table in the SeaTable system is called dtable (database table)

## App Directory Structure

```
build ----------------------------------- folder after project compilation
config ---------------------------------- project compilation configuration folder
app-config ------------------------------ project zip package configuration folder
app-zip --------------------------------- project zip folder after zip packaging
public ---------------------------------- project local development static files folder
scripts --------------------------------- project packaging scripts
src ------------------------------------- project source folder
  app.js -------------------------------- project main code
  index.js ------------------------------ Entry file in the development environment
  css ----------------------------------- project style source folder
  widge --------------------------------- project components source folder
```

## App Package

The plug-in package is a file in zip format. The directory structure after decompression is as follows

```
   your-app
     - main.js // compiled js file
     - info.json // app info file
     - main.css // compiled css file
```

info.json description

```
{
  "name": '', // English name of app, can only contain letters, numbers, underscores, and underscores
  "version": '', // app version number, need to be in a format like 1.0.3
  "display_name": '', // the name the app displays on the interface
  "description": '', // description of app function
  "has_css": true / false, // whether the app contains css files
  "has_icon": true / false, // whether the app contains icon images
  "has_card_image": true / false // whether the app contains a background image
}
```

## App working mode

Apps can be run in two ways, one is a development environment, and the other is a production environment. The two ways are same working mode.

When the program is initialized, the table on the server is loaded through the information in the configuration file, and then a search input and search result table is actively displayed.

## Basic process of app development

### 1. clone project

* clone current project to local
  
### 2. Modify the app information file

* Optional: Add a custom icon.png as the icon of the app in the app-config folder (if it is not provided, the default icon will be used. icon.png requires 128x128 pixels)
* Optional: Add custom card_image.png as the background image of the app icon in the app-config folder (if it is not provided, the default background is displayed. card_image.png is required to be 560x240 pixels, the actual display is 280x120 pixels.
* Modify info.json configuration file in app-config folder

```
  "name": '', // English name of app, can only contain letters, numbers, underscores, and underscores
  "version": '', // app version number
  "display_name": '', // name of the app display
  "description": '', // description of app function
```

There is no need to add other configuration parameters here, other parameters are automatically generated by the packaging tool

### 3. Modify app development configuration file index.js

The configuration file is used for local development to get dtable data.

```
Configuration parameter description:

const config = {
  APIToken: "**", // dtable api token to be added
  server: "**".replace(/\/+$/, ""), // The server URL of the dtable to which the app needs to be added
  workspaceID: "**", // The id value of the workspace where the dtable of the app needs to be added
  dtableName: "**", // The name of the dtable to add the app to
  tableName: "**", // The name of the sub-dtable to add the app to
  lang: "**" // default language type, en or zh-cn
};
```

### 4. Add internationalization support(optional)

#### There are two cases of app internationalization

1. App display name internationalization
2. Internationalization of the internal content of the app: The translation strings should be placed in js files and packaged with the app's other js source files into a final js file.


#### App display name internationalization

The name displayed by the plug-in can also provide an international display. If you need to provide internationalization for the display name of the plug-in, you can modify the display_name parameter in the plug-in configuration information file `info.json`, the modification type is as follows:

```
display_name: {
  'en': '',
  'fr': '',
  'de': '',
  'zh-cn': '',
  ...
}
```

If you do not need to provide internationalization for the display name of the plug-in, you can directly assign the display_name parameter in the plug-in configuration information file `info.json`

```
display_name: ''
```


#### Internationalization of the internal content of the app

We recommend to use [react-intl-universal](https://github.com/alibaba/react-intl-universal) for app internationalization.

This library support internationalization for the following contents:
1. Number
2. Currency
3. Date
4. Times
5. Message（Default Message、Message With Variables、HTML Message)

Steps:
1. Add supported language files in `src/locale/lang` **. Js
2. Add the corresponding international key and value key-value pairs in the file
3. In `src/locale/index.js` file
    * Import the defined language file
    * Define the language type supported by default
    * Add language to locales object
4. Import translation components in components that need to add internationalized content `import intl from 'react-intl-universal`
5. Call the intl interface function to complete the corresponding international call work, please use the documentation to move ➡️[react-intl-universal](https://github.com/alibaba/react-intl-universal)

### 5. Start development

* Run `npm install` to install app dependencies
* Run `npm run start` to run the local development environment
* Todo: At this time, app name, a search input and buttons group are displayed on the interface.
  1. The dtable value (tables) can be obtained through the getTables interface function provided by dtable.
  2. The collaborators can be obtained through the getRelatedUsers interface function provided by dtable.
  3. Enter some texts in search input and press search button, then you will see result below.
* According to requirements, use the interface functions provided by dtable-sdk to update app.js to complete the plug-in function development

app.js main code explained

```jsx
import React from 'react';
import DTable from 'dtable-sdk';

class App extends React.Component {

  constructor(props) {
    super(props);
    this.dtable = new DTable();
  }

  componentDidMount() {
    this.initAllDTableData();  
  }

  async initAppDTableData() {
    if (window.app === undefined) {
      // local develop
      window.app = {};
      await this.dtable.init(window.dtableAppConfig);
      await this.dtable.syncWithServer();
      this.dtable.subscribe('dtable-connect', () => { this.onDTableConnect(); });
    } else { 
      // integrated to dtable app
      this.dtable.initInBrowser(window.app.dtableStore);
    }
    this.dtable.subscribe('remote-data-changed', () => { this.onDTableChanged(); });
    this.resetData();
    // get table data and collaborators
    this.table = this.dtable.getTableByName(window.dtableAppConfig.tableName);
    this.collaborators = this.dtable.getRelatedUsers();
  }

  onDTableConnect = () => {
    this.resetData();
  }

  onDTableChanged = () => {
    this.resetData();
  }

  resetData = () => {
    this.setState({
      isLoading: false,
    });
  }

  render() {
    let { isLoading } = this.state;
    if (isLoading) {
      return <Loading/>;
    }
    const preCl = 'dtable-app';
    return (
      <div className={`${preCl} w-100`}>
        <h2 className={`${preCl}-header`}>{'Search APP'}</h2>
        <div className={`${preCl}-search mx-4`}>
          <Label className="mr-2">{'Wechat name'}</Label>
          <Input
            type="text"
            className={`${preCl}-search-input`}
            value={this.state.searchValue}
            onChange={this.onInputChange}
            onKeyDown={this.onKeyDown}
          />
          <Button onClick={this.searchRow} className="ml-2 mb-1">{'Search'}</Button>
          <Button onClick={this.clearSearch} className="ml-2 mb-1">{'Clear'}</Button>
        </div>
        <div className={`${preCl}-body`}>
          <Content
            rows={this.state.rows}
            columns={this.table.columns}
            collaborators={this.collaborators}
          />
        </div>
      </div>
    );
  }
}

export default App;
```

## Build zip package and upload app

1. Run `npm run build-app` to package the app
2. Upload the app to dtable

